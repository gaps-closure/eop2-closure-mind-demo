<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="CLOSURE+MIND GAPS Demonstration">
  <meta name="keywords"    content="H.264 player, Trillium camera, jMuxer">
  <title>CLOSURE+MIND GAPS Demonstration</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" crossorigin=""
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="/>
  <style>
     html, body {height: 100%; margin: 0 auto;}
     .leaflet-container {margin: 0 auto; height: 400px; width: 600px; max-width: 100%; max-height: 100%;}
  </style>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" crossorigin=""
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="></script>
  <script type="text/javascript" src="jmuxer.min.js"></script>
</head>

<body>
<H1>GAPS Demonstration</H1>

<table><tr>
  <td> 
    <div id="map" style="width: 600px; height: 400px;"></div> 
  </td>
  <td>
    <br />
    <video style="border: 1px solid #333;" controls poster="loader-thumb.jpg" id="player"></video> 
    <br />
    <textarea id="llat" name="llat" rows=4 cols=40 style="overflow:hidden;resize:none;border:none;outline:none;"></textarea>
    <br />
    <form onsubmit="return postCommand();">
      <table>
      <tr>
      <td><label for="imptime">Impulse (s):</label></td>
      <td><input type="number" style="text-align: right;" step="0.1" size=6 value=0.0 id="imptime" /></td>
      </tr>
      <tr>
      <td><label for="stab">Stabilized:</label></td>
      <td><input type="checkbox" id="stab" name="stab" value="1"></td>
      </tr>
      <tr>
      <td><label for="cammode">Mode:</label></td>
      <td><select name="cammode" id="cammode">
        <option value="P" selected="selected">Position</option>
        <option value="R">Rate</option>
        <option value="D">Disable</option>
        <option value="F">FFC</option>
      </select></td>
      </tr>
      <tr>
      <td><label for="pan">Pan (&deg;):</label></td>
      <td><input type="number" style="text-align: right;" step="0.1" size=6 value=0.0 id="pan" /></td>
      </tr>
      <tr>
      <td><label for="tilt">Tilt (&deg;):</label></td>
      <td><input type="number" style="text-align: right;" step="0.1" size=6 value=0.0 id="tilt" /></td>
      </tr>
      <tr>
      <td></td>
      <td><input type="submit" value="Send"></td>
      </tr>
    </form>
  </td>
</tr></table>

<script>
var map          = L.map('map').setView([40.69,-74.57], 14);
var socketURL    = 'wss://localhost:8443/ws/video';
var jm           = null;
var ws           = null;
var llatInterval = null;

var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

<!-- Placeholder, connect to LL -->
var marker = L.marker([40.69498019344514, -74.57273928765258]).addTo(map);

function getLLAT() {
  return "Not implemented yet";
  // return "Lat: \nLon: \nAlt: \nTime: \n";
}

function postCommand() {
  alert('Not implemented yet');
  return;
}

function closews() {
  if(llatInterval) clearInterval(llatInterval);
  if (ws) ws.close();
  if (jm) jm.destroy();
  llatInterval = null;
  ws = null;
  jm = null;
};

function renews() {
  llatInterval = setInterval(function(){ta.value = getLLAT();}, 250);
  jm = new JMuxer({
    node: 'player',
    mode: 'video',
    flushingTime: 1000,
    fps: 25,
    debug: false,
  });
  ws = new WebSocket(socketURL);
  ws.binaryType = 'arraybuffer';
  ws.addEventListener('message', function(e) { jm.feed({video: new Uint8Array(e.data)}); });
  ws.addEventListener('error',   function(e) { console.log('Socket Error'); });
};

window.onload = function() {
  var vw = document.getElementById('player');
  var ta = document.getElementById('llat');

  vw.addEventListener('play', function(e) { 
    renews();
  });

  vw.addEventListener('pause', function(e) { 
    closews();
    location.reload(); //XXX: not working as expected without reload
  });
};
</script>

</body>
</html>
